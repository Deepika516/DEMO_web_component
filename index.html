<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Document</title>
    <!-- <script src="https://unpkg.com/@webcomponents/custom-elements"></script>
<script src="https://unpkg.com/@webcomponents/shadydom"></script> -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/icons/icomoon/style.css"
    />
    <link rel="stylesheet" type="text/css" href="/styles.css" />

    <style>
      html,
      body {
        height: 100%;
      }
      body {
        margin-top: 150px;
        margin-left: 50px;
        font-family: Roboto, "Helvetica Neue", sans-serif;
      }
    </style>
  </head>
  <body>
    <sourceloop-workflow-element></sourceloop-workflow-element>

    <script type="text/javascript" src="workflows-element.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const element = document.querySelector("sourceloop-workflow-element");

        const NORMALIZED_COLUMN = [
          {
            text: "Status",
            value: "1952177d-9a3e-6ef4-ae8f-522c08153026",
          },
          {
            text: "Priority",
            value: "1952177d-9a3e-6ef4-ae8f-522c08153026",
          },
          {
            text: "Dropdown",
            value: "1952177d-9a3e-6ef4-ae8f-522c08153020",
          },
          {
            text: "People",
            value: "a7135732-096c-9b41-2696-90a195d3c383",
          },
          {
            text: "Text",
            value: "2069d144-db46-0737-2c9d-bc339949d684",
          },
          {
            text: "Numbers",
            value: "47beeecd-712c-6f8b-c595-92c3712780cb",
          },
          {
            text: "Date/Time",
            value: "6f1e6eee-5a04-6a2e-173f-a354f569f1e5",
          },
          {
            text: "Date",
            value: "5b79f82b-0e7b-8e74-5e71-909a473e5c07",
          },
          {
            text: "Assignee",
            value: "d1e36f1e-8539-91ab-cabf-37799009fb52",
          },
        ];

        const TIMESCALE = [
          { text: "Days", value: "D", timescale: "" },
          { text: "Hours", value: "H", timescale: "T" },
          { text: "Seconds", value: "S", timescale: "T" },
        ];

        const VALUE_TYPES = [
          {
            text: "ANYTHING",
            value: "anyValue",
          },
          {
            text: "CUSTOM_VALUE",
            value: "customValue",
          },
        ];

        const FIELD_VALUES = {
          status: {
            valueInputType: "list",
            values: [
              { text: "Todo", value: "todo" },
              { text: "In Progress", value: "in_progress" },
            ],
          },
          priority: {
            valueInputType: "list",
            values: [
              { text: "Critical", value: "critical" },
              { text: "High", value: "high" },
              { text: "Medium", value: "medium" },
              { text: "Low", value: "low" },
            ],
          },
          date: {
            valueInputType: "date",
          },
          datetime: {
            valueInputType: "datetime",
          },
          people: {
            valueInputType: "people",
          },
          text: {
            valueInputType: "text",
          },
          number: {
            valueInputType: "number",
          },
        };

        const DEFAULT_CONDITION = [
          { text: "Equal", value: "equal" },
          { text: "Not Equal", value: "notequal" },
          { text: "Changes", value: "changes" },
        ];
        const DATE_CONDITIONS = [
          { text: "Past Today", value: "pastToday" },
          { text: "Coming In", value: "comingIn" },
          { text: "Past by", value: "pastby" },
          { text: "Changes", value: "changes" },
        ];
        const CONDITIONS = {
          date: DATE_CONDITIONS,
          datetime: DATE_CONDITIONS,
        };

        let selectedCol;
        let selectedColumnType;
        const gatewayType = new Map();
        prepareGatewayTypeForAvailableConditions();
        let gatewayTypeCol = [];
        let diagram = "";

        element.addEventListener("diagramChange", (event) => {
          diagram = event.detail;
          // console.log(diagram);
        });
        element.addEventListener("eventAdded", (event) => {
          elementClick(event.detail);
        });
        element.addEventListener("actionAdded", (event) => {
          elementClick(event.detail);
        });
        element.addEventListener("itemChanged", (event) => {
          valueChanges(event.detail);
        });

        function elementClick(event) {
          const selectedElement = event.event ?? event.action;
          switch (selectedElement.getIdentifier()) {
            case "OnIntervalEvent":
              selectedElement.state.change("intervalList", TIMESCALE);
              selectedElement.state.change("valuePlaceholder", "n");
            case "OnChangeEvent":
            case "OnValueEvent":
            case "ChangeColumnValueAction":
              selectedElement.state.change("columns", NORMALIZED_COLUMN);
              break;
          }
        }

        // function valueChanges(event) {
        //

        function valueChanges(event) {
          let selectedCol;
          // event.item.state.change('boardId', data.boardId);
          switch (event.field) {
            case "ValueInput":
              //const _timescale = TIMESCALE;
              // if (
              //   environment.workflowLowerIntervalScale === TimeScaleEnum.Hours
              // )
              // {
              //   _timescale.push({
              //     text: 'Hours',
              //     value: 'H',
              //     timescale: 'T',
              //   });
              // }
              if (event.item.getIdentifier() === "OnIntervalEvent") {
                event.item.state.change("intervalList", TIMESCALE);
                return;
              }
              break;
            case "IntervalInput":
              const timescale = TIMESCALE.find(
                (time) => time.value === event.value
              )?.timescale;
              event.item.state.change("timescale", timescale);
              break;
              case 'TriggerColumnInput':

            case "ColumnInput":
              selectedCol = NORMALIZED_COLUMN.find(
                (col) => col.value === event.value
              );
              selectedColumnType = selectedCol.text?.toLowerCase();
              const condition =
                CONDITIONS[selectedCol.text?.toLowerCase()] ||
                DEFAULT_CONDITION;
              if (selectedCol) {
                event.item.state.change("conditions", condition);
              }
            case "ConditionInput":
            case "ToColumnInput":
              selectedCol = NORMALIZED_COLUMN.find(
                (col) => col.value === event.value
              );
              if (selectedCol)
                selectedColumnType = selectedCol.text?.toLowerCase();
              event.item.state.change(
                "valueInputType",
                FIELD_VALUES[selectedColumnType].valueInputType
              );
              if (FIELD_VALUES[selectedColumnType].values) {
                event.item.state.change(
                  "values",
                  FIELD_VALUES[selectedColumnType].values
                );
              }

              break;
            case "EmailDataInput":
              const notify = [
                {
                  text: WORKFLOW_CONST.notifyMeLBl,
                  value: NotificationRecipientTypesEnum.NotifyMe,
                },
                {
                  text: WORKFLOW_CONST.notifyEveryoneOnTheProjectLbl,
                  value: NotificationRecipientTypesEnum.NotifyEveryoneOnProject,
                },
                {
                  text: WORKFLOW_CONST.notifyProjectOwnersLbl,
                  value: NotificationRecipientTypesEnum.NotifyProjectOwners,
                },
                {
                  text: WORKFLOW_CONST.notifySpecificPeopleLbl,
                  value: NotificationRecipientTypesEnum.NotifySpecificPeople,
                },
                {
                  text: WORKFLOW_CONST.notifySpecificColumn,
                  value: NotificationRecipientTypesEnum.NotifySpecificColumn,
                },
              ];
              event.item.state.change("emailToInputType", InputTypes.List);
              event.item.state.change("emailToValues", notify);
              if (event.value) {
                event.item.state.change("subject", event.value.subject);
                event.item.state.change("body", event.value.body);
              }
              break;
            case "EmailToInput": {
              // performSelectNotifRecipient(event);
              event.item.state.change("recipientType", event.value);
              break;
            }
            case "EmailRecepientInput":
              if (
                event.item.state.get("emailTo") !==
                NotificationRecipientTypesEnum.NotifySpecificColumn
              ) {
                event.item.state.change("recipients", event.value?.ids);
              } else {
                event.item.state.change("peopleColumnId", event.value);
              }
              break;
          }
        }

        function prepareGatewayTypeCollection(event) {
          if (gatewayType.get("equal").includes(selectedColumnType)) {
            gatewayTypeCol.push({
              text: "Equal",
              value: "equal",
            });

            gatewayTypeCol.push({
              text: "Not Equal",
              value: "notequal",
            });
          }

          if (gatewayType.get("greaterThan").includes(selectedColumnType)) {
            gatewayTypeCol.push({
              text: "Greater Than",
              value: "greaterThan",
            });

            gatewayTypeCol.push({
              text: "Less than",
              value: "lessThan",
            });
          }

          if (gatewayType.get("dueindays").includes(selectedColumnType)) {
            gatewayTypeCol.push({
              text: "Past Today",
              value: "pasttoday",
            });

            gatewayTypeCol.push({
              text: "Coming In {num} daya",
              value: "comingin",
            });

            gatewayTypeCol.push({
              text: "Past By",
              value: "pastby",
            });
          }

          if (gatewayType.get("like").includes(selectedColumnType)) {
            gatewayTypeCol.push({
              text: "like",
              value: "like",
            });
          }
        }
        // function prepareGatewayTypeCollection() {
        //   if (
        //     gatewayType.get("equal").includes(selectedColumnType)
        //   ) {
        //     gatewayTypeCol.push({
        //       text: "Equal",
        //       value: "equal",
        //     });

        //     gatewayTypeCol.push({
        //       text: "NotEqual",
        //       value: "notequal",
        //     });
        //   }
        // }

        // if (
        //   gatewayType
        //     .get(GatewayTypeEnum.GreaterThan)
        //     .includes(selectedColumnType)
        // ) {
        //   gatewayTypeCol.push({
        //     text: localisedStrings.greaterThanLbl,
        //     value: GatewayTypeEnum.GreaterThan,
        //   });

        //   gatewayTypeCol.push({
        //     text: localisedStrings.lessThanLbl,
        //     // value: GatewayTypeEnum.LessThan,
        //   });
        // }

        function setColumnType(event, selectedCol) {
          event.item.state.remove("valuePlaceholder");
          if (event.field === "ToColumnInput") {
            selectedCol = NORMALIZED_COLUMN.find(
              (col) => col.value === event.value
            );
            selectedColumnType = selectedCol.text.toLowerCase();
            gatewayTypeCol = [];
          }
          if (
            ["comingin", "pastby"].includes(event.value) &&
            ["date", "datetime"].includes(selectedColumnType)
          ) {
            event.item.state.change("valuePlaceholder", "n");
            event.item.state.change("valueInputType", "number");
            return;
          }

          switch (selectedColumnType) {
            case "datetime":
            case "date":
              if (
                event.item.name.toLowerCase() ===
                localisedStrings.changeColumnValueLbl.toLowerCase()
              ) {
                event.item.state.change("valueInputType", selectedColumnType);
                break;
              }
            // eslint-disable-next-line no-fallthrough
            case "status":
            case "priority":
            case "dropdown":
              setDropdownType(event, selectedCol);
              break;
            // case "people":
            //   prepareBoardMemberCollection();
            //   event.item.state.change("valueInputType", "people");
            // //  event.item.state.change("values", userCol);
            //   setNonDropdownTypeColumnValues(event);
            //   break;
            case "number":
            case "percentage":
            // case 'currency':
            //   setNonDropdownTypeColumnValues(event);
            //   event.item.state.change("valueInputType", 'number');
            //   break;
            case "text":
              if (!event.item.trigger) {
                event.item.state.change("valueTypes", VALUE_TYPES);
              }
              event.item.state.change("valueInputType", "text");
              break;
          }
        }

        function setDropdownType(event, selectedCol) {
          if (!selectedCol) {
            selectedCol = NORMALIZED_COLUMN.find(
              (col) => col.value === event.item.state.get("column")
            );
          }
          prepareDropdownTypeColumnValueCollection(
            selectedCol,
            true,
            event.item.trigger
          );
          event.item.state.change("valueInputType", "list");
          event.item.state.change("values", [
            { text: "hie", value: "hie tiny" },
          ]);
          if ("equal" || "notequal") {
            event.item.state.change("conditionPrefix", "to");
          }
        }

        function prepareDropdownTypeColumnValueCollection(
          column,
          addBlank = false,
          addAnything = false
        ) {
          let possibleValues;
          columnValueCol = [];
          // if (column.columnType === ColumnTypesEnum.people) {
          //   prepareBoardMemberCollection();
          // } else
          if (
            column.text.toLowerCase() === "date" ||
            column.text.toLowerCase() === "datetime"
          ) {
            columnValueCol.push(
              ...[
                {
                  text: "todaylbl",
                  value: "today",
                },
                {
                  text: "pastDateLbl",
                  value: "pasttoday",
                },
              ]
            );
          } else {
            switch (column.columnType) {
              case "status":
                possibleValues = column?.metaData?.availableStatus;
                break;
              case "priority":
                possibleValues = column?.metaData?.availablePriorities;
                break;
              case "dropdown":
                possibleValues = column?.metaData?.options;
                break;
              default:
                possibleValues = [];
            }

            possibleValues?.forEach((status) => {
              const obj = {
                text: `"${status.displayValue}"`,
                value: status.value,
                color: status.color,
                iconClass: status.iconClass,
                bgColor: status.bgColor,
              };
              columnValueCol.push(obj);
            });

            if (addBlank) {
              addBlankOptionInDropdown(column);
            }
          }
          if (addAnything) {
            columnValueCol.unshift({
              text: ANYTHING_DISPLAY_VALUE,
              value: ANYTHING_VALUE,
            });
          }
        }

        function prepareGatewayTypeForAvailableConditions() {
          gatewayType.set("equal", [
            "status",
            "dropdown",
            "priority",
            "number",
            "percentage",
            "currency",
            "text",
            "people",
          ]);

          gatewayType.set("greaterThan", ["number", "percentage", "currency"]);

          gatewayType.set("dueindays", ["date", "datetime"]);

          gatewayType.set("like", ["text"]);
          gatewayType.set("changes", [
            "status",
            "dropdown",
            "priority",
            "number",
            "percentage",
            "currency",
            "text",
            "people",
            "date",
            "datetime",
          ]);
        }
      });
    </script>
  </body>
</html>
