<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Document</title>
    <!-- <script src="https://unpkg.com/@webcomponents/custom-elements"></script>
<script src="https://unpkg.com/@webcomponents/shadydom"></script> -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/icons/icomoon/style.css"
    />
    <link rel="stylesheet" type="text/css" href="/styles.css" />

    <style>
      html,
      body {
        height: 100%;
      }
      body {
        margin-top: 150px;
        margin-left:50px;
        font-family: Roboto, "Helvetica Neue", sans-serif;
      }
    </style>
  </head>
  <body>
    <sourceloop-workflow-element></sourceloop-workflow-element>

    <script type="text/javascript" src="workflows-element.js"></script>


    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const element = document.querySelector("sourceloop-workflow-element");
        
        // Add stateChange event listener
        // element.state = {};
        element.addEventListener("stateChange", (event) => {
          const newState = event.detail;
          
          // Your stateChange event handling code
        });
        element.diagram = "";

        // Add diagramChange event listener
        element.addEventListener("diagramChange", (event) => {
          const newDiagram = event.detail;
          // Your diagramChange event handling code
        });

        // element.localizedStringMap = {};
        let localeMap = {};
        const LocalizedStringKeys = {
          WhenThisHappens: "whenThisHappensLbl",
          DoThis: "doThisLbl",
          ColumnChanges: "columnChangesLbl",
          ChangesTo: "triggerColumnSuffix",
          OnInterval: "onIntervalLbl",
          OnAddItem: "onAddItemLbl",
          ItemCreated: "itemCreatedLbl",
          CheckValue: "checkValueLbl",
          ChangeValue: "changeValueLbl",
          SendAnEmail: "sendAnEmailLbl",
          Else: "elseLbl",
          TypeSubject: "typeSubjectLbl",
          TypeEmail: "typeEmailLbl",
          SelectColumnTooltip: "selectColumnTooltip",
          SetLbl: "setLbl",
        };

        localeMap[LocalizedStringKeys.WhenThisHappens] = "When This Happens";
        localeMap[LocalizedStringKeys.DoThis] = "Do This";
        localeMap[LocalizedStringKeys.ColumnChanges] = "Column Changes";
        localeMap[LocalizedStringKeys.OnInterval] = "On Interval";
        localeMap[LocalizedStringKeys.OnAddItem] = "On Add Item";
        localeMap[LocalizedStringKeys.ItemCreated] = "Item Created";
        localeMap[LocalizedStringKeys.CheckValue] = "Check Value";
        localeMap[LocalizedStringKeys.ChangeValue] = "Change Value";
        localeMap[LocalizedStringKeys.SendAnEmail] = "Send An Email";
        localeMap[LocalizedStringKeys.Else] = "else";
        localeMap[LocalizedStringKeys.TypeSubject] = "Type Subject";
        localeMap[LocalizedStringKeys.TypeEmail] = "Type Email";
        localeMap[LocalizedStringKeys.SelectColumnTooltip] =
          "Select Column Tooltip";
       element.localizedStringMap = localeMap;
      // Object.assign(element['localizedStringMap'],localeMap);
      console.log(element.localizedStringMap)

// state inputs
      const NORMALIZED_COLUMN = [
        {
          text: 'Status',
          value: '1952177d-9a3e-6ef4-ae8f-522c08153026',
        },
        {
          text: 'Priority',
          value: '1952177d-9a3e-6ef4-ae8f-522c08153026',
        },
        {
          text: 'Dropdown',
          value: '1952177d-9a3e-6ef4-ae8f-522c08153020',
        },
        {
          text: 'People',
          value: 'a7135732-096c-9b41-2696-90a195d3c383',
        },
        {
          text: 'Text',
          value: '2069d144-db46-0737-2c9d-bc339949d684',
        },
        {
          text: 'Numbers',
          value: '47beeecd-712c-6f8b-c595-92c3712780cb',
        },
        {
          text: 'Date/Time',
          value: '6f1e6eee-5a04-6a2e-173f-a354f569f1e5',
        },
        {
          text: 'Date',
          value: '5b79f82b-0e7b-8e74-5e71-909a473e5c07',
        },
        {
          text: 'Assignee',
          value: 'd1e36f1e-8539-91ab-cabf-37799009fb52',
        },
      ];

      const DEFAULT_CONDITION = [
        {text: 'Equal', value: 'equal'},
        {text: 'Not Equal', value: 'notequal'},
        {text: 'Changes', value: 'changes'},
      ];

      const DATE_CONDITIONS = [
        {text: 'Past Today', value: 'pastToday'},
        {text: 'Coming In', value: 'comingIn'},
        {text: 'Past by', value: 'pastby'},
        {text: 'Changes', value: 'changes'},
      ];

      const CONDITIONS = {
        date: DATE_CONDITIONS,
        datetime: DATE_CONDITIONS,
      };

      const FIELD_VALUES = {
      status: {
          valueInputType: 'list',
          values: [
            {text: 'Todo', value: 'todo'},
            {text: 'In Progress', value: 'in_progress'},
          ],
        },
      priority: {
        valueInputType: 'list',
        values: [
          {text: 'Critical', value: 'critical'},
          {text: 'High', value: 'high'},
          {text: 'Medium', value: 'medium'},
          {text: 'Low', value: 'low'},
        ],
      },
      date: {
        valueInputType: 'date',
      },
      datetime: {
        valueInputType: 'datetime',
      },
      people: {
        valueInputType: 'people',
      },
      text: {
        valueInputType: 'text',
      },
      number: {
        valueInputType: 'number',
      },
    }
    element.state = {
    columns: NORMALIZED_COLUMN,
    conditions:[],
    values:[],
  }

   element.addEventListener('eventAdded', e => {
    debugger
        console.log(event.detail); 
        elementClick(e.detail)// Not working
      });

        element.allColumns = [
          {
            text: "Status",
            value: "{{Status}}",
          },
          {
            text: "People",
            value: "{{People}}",
          },
          {
            text: "Text",
            value: "{{Text}}",
          },
          {
            text: "Numbers",
            value: "{{Numbers}}",
          },
          {
            text: "Date/Time",
            value: "{{Date/Time}}",
          },
          {
            text: "Date",
            value: "{{Date}}",
          },
          {
            text: "Assignee",
            value: "{{Assignee}}",
          },
        ];
        // Add eventAdded event listener 

       function elementClick(event){

        debugger;
          const selectedElement = event.event ?? event.action;
          console.log(event);
          let columns = NORMALIZED_COLUMN;
          console.log(columns);
          switch (selectedElement.getIdentifier()) {
            case "OnChangeEvent":
            case "OnValueEvent":
              selectedElement.state.change('columns', columns);
            break;
         }
  }

       function valueChanges(event) {
    let selectedCol;
    event.item.state.change('boardId', this.data.boardId);
    switch (event.field) {
      case "ValueInput":
        const _timescale = TIMESCALE;
        if (
          this.environment.workflowLowerIntervalScale === TimeScaleEnum.Hours
        ) {
          _timescale.push({
            text: 'Hours',
            value: 'H',
            timescale: 'T',
          });
        }
        if (event.item.getIdentifier() === 'OnIntervalEvent') {
          event.item.state.change('intervalList', _timescale);
          return;
        }
        break;
      case "IntervalInput":
        const timescale = TIMESCALE.find(
          time => time.value === event.value,
        )?.timescale;
        event.item.state.change('timescale', timescale);
        break;
      case "ColumnInput":
        selectedCol = NORMALIZED_COLUMN.find(col => col.value === event.value);
        this.selectedColumnType =
          selectedCol.text?.toLowerCase()
        const condition =
          CONDITIONS[selectedCol.text?.toLowerCase()] || DEFAULT_CONDITION;
        if (selectedCol) {
          event.item.state.change('conditions', condition);
        }
        break;
      case "ConditionInput":
      case ToColumnInput.identifier:
        selectedCol = NORMALIZED_COLUMN.find(col => col.value === event.value);
        if(selectedCol)
        this.selectedColumnType =
        selectedCol.text?.toLowerCase()
        event.item.state.change(
          'valueInputType',
          FIELD_VALUES[this.selectedColumnType].valueInputType,
        );
        if (FIELD_VALUES[this.selectedColumnType].values) {
          event.item.state.change(
            'values',
            FIELD_VALUES[this.selectedColumnType].values,
          );
        }

        break;
      case "EmailDataInput":
        const notify = [
          {
            text: WORKFLOW_CONST.notifyMeLBl,
            value: NotificationRecipientTypesEnum.NotifyMe,
          },
          {
            text: WORKFLOW_CONST.notifyEveryoneOnTheProjectLbl,
            value: NotificationRecipientTypesEnum.NotifyEveryoneOnProject,
          },
          {
            text: WORKFLOW_CONST.notifyProjectOwnersLbl,
            value: NotificationRecipientTypesEnum.NotifyProjectOwners,
          },
          {
            text: WORKFLOW_CONST.notifySpecificPeopleLbl,
            value: NotificationRecipientTypesEnum.NotifySpecificPeople,
          },
          {
            text: WORKFLOW_CONST.notifySpecificColumn,
            value: NotificationRecipientTypesEnum.NotifySpecificColumn,
          },
        ];
        event.item.state.change('emailToInputType', InputTypes.List);
        event.item.state.change('emailToValues', notify);
        if (event.value) {
          event.item.state.change('subject', event.value.subject);
          event.item.state.change('body', event.value.body);
        }
        break;
      case "EmailToInput": {
        // this.performSelectNotifRecipient(event);
        event.item.state.change('recipientType', event.value);
        break;
      }
      case "EmailRecepientInput":
        if (
          event.item.state.get('emailTo') !==
          NotificationRecipientTypesEnum.NotifySpecificColumn
        ) {
          event.item.state.change('recipients', event.value?.ids);
        } else {
          event.item.state.change('peopleColumnId', event.value);
        }
        break;
    }
  }

  // Add actionAdded event listener
        element.addEventListener("actionAdded", e => {
          debugger;
          console.log(event.detail);
          valueChanges(event);
          // Your actionAdded event handling code
        });

        // Add itemChanged event listener
        element.addEventListener("itemChanged", (event) => {
          const newChangedItem = event.detail;
          // Your itemChanged event handling code
        });
      });
    </script>
  </body>
</html>
